<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³ ê° ë¬¸ì˜ ì±„íŒ…</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .login-container div {
            margin-bottom: 15px;
        }
        .login-container input {
            padding: 10px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .login-container button {
            padding: 12px 20px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }
        
        /* ì¼ë°˜ ì‚¬ìš©ì ì±„íŒ… í™”ë©´ */
        .user-chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        
        /* ê´€ë¦¬ì ì±„íŒ… í™”ë©´ */
        .admin-chat-container {
            display: none;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 80vh;
        }
        .admin-layout {
            display: flex;
            height: 100%;
        }
        .customer-list {
            width: 300px;
            border-right: 1px solid #ddd;
            background-color: #f8f9fa;
        }
        .customer-list-header {
            padding: 15px;
            background-color: #343a40;
            color: white;
            font-weight: bold;
        }
        .customer-item {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            position: relative;
        }
        .customer-item:hover {
            background-color: #e9ecef;
        }
        .customer-item.active {
            background-color: #007bff;
            color: white;
        }
        .customer-item .customer-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        .customer-item .last-message {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .customer-item.active .last-message {
            color: #fff;
        }
        .unread-badge {
            position: absolute;
            top: 8px;
            right: 10px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 15px;
            background-color: #2196f3;
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #f9f9f9;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 70%;
            word-break: break-word;
        }
        .user-message {
            background-color: #e3f2fd;
            margin-right: auto;
        }
        .admin-message {
            background-color: #fff3e0;
            margin-left: auto;
            border-left: 4px solid #ff9800;
        }
        .message-time {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }
        .chat-input {
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        .chat-input button {
            padding: 10px 20px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
        .chat-input button:hover {
            background-color: #388e3c;
        }
        .status {
            text-align: center;
            font-size: 12px;
            color: #666;
            padding: 10px;
        }
        .welcome-msg {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
        }
        .no-customer-selected {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center;">ğŸ› ï¸ ê³ ê° ë¬¸ì˜ ì±„íŒ… ì‹œìŠ¤í…œ</h1>

        <!-- ë¡œê·¸ì¸ í¼ -->
        <div class="login-container" id="login-form">
            <h3 style="text-align: center;">ë¡œê·¸ì¸</h3>
            <div>
                <label for="user-id">ì´ë©”ì¼:</label>
                <input type="text" id="user-id" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div>
                <label for="user-pw">ë¹„ë°€ë²ˆí˜¸:</label>
                <input type="password" id="user-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <button id="login-btn">ë¡œê·¸ì¸</button>
            <div style="text-align: center; margin-top: 10px;">
                <span id="login-status"></span>
            </div>
        </div>

        <!-- ì¼ë°˜ ì‚¬ìš©ì ì±„íŒ… í™”ë©´ -->
        <div class="user-chat-container" id="user-chat-container">
            <div class="chat-header" id="user-chat-header">ğŸ’¬ ê´€ë¦¬ìì™€ì˜ ë¬¸ì˜ ì±„íŒ…</div>
            
            <div class="welcome-msg">
                ì•ˆë…•í•˜ì„¸ìš”! ê¶ê¸ˆí•œ ì ì´ë‚˜ ë¬¸ì˜ì‚¬í•­ì„ ììœ ë¡­ê²Œ ë‚¨ê²¨ì£¼ì„¸ìš”. <br>
                ê´€ë¦¬ìê°€ ìµœëŒ€í•œ ë¹ ë¥´ê²Œ ë‹µë³€ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ğŸ˜Š
            </div>
            
            <div class="chat-messages" id="user-chat-messages"></div>
            
            <div class="chat-input">
                <input type="text" id="user-message-input" placeholder="ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...">
                <button id="user-send-btn">ì „ì†¡</button>
            </div>
            
            <div class="status" id="user-connection-status">ì—°ê²° ìƒíƒœ: ëŒ€ê¸°ì¤‘</div>
        </div>

        <!-- ê´€ë¦¬ì ì±„íŒ… í™”ë©´ -->
        <div class="admin-chat-container" id="admin-chat-container">
            <div class="admin-layout">
                <!-- ê³ ê° ëª©ë¡ -->
                <div class="customer-list">
                    <div class="customer-list-header">
                        ğŸ’¼ ê³ ê° ëª©ë¡ (<span id="customer-count">0</span>)
                    </div>
                    <div id="customer-list-content">
                        <div style="padding: 20px; text-align: center; color: #666;">
                            ì—°ê²°ëœ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤
                        </div>
                    </div>
                </div>
                
                <!-- ì±„íŒ… ì˜ì—­ -->
                <div class="chat-area">
                    <div class="chat-header" id="admin-chat-header">
                        <span id="selected-customer-name">ê³ ê°ì„ ì„ íƒí•˜ì„¸ìš”</span>
                        <span id="admin-connection-status">ì—°ê²° ìƒíƒœ: ëŒ€ê¸°ì¤‘</span>
                    </div>
                    
                    <div class="chat-messages" id="admin-chat-messages">
                        <div class="no-customer-selected" id="no-customer-selected">
                            ğŸ‘ˆ ì™¼ìª½ì—ì„œ ê³ ê°ì„ ì„ íƒí•˜ë©´ ì±„íŒ…ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                        </div>
                    </div>
                    
                    <div class="chat-input" id="admin-chat-input" style="display: none;">
                        <input type="text" id="admin-message-input" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”...">
                        <button id="admin-send-btn">ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ìƒíƒœ ë³€ìˆ˜
        let userPk = null;
        let userEmail = null;
        let isCurrentUserAdmin = false;
        let socket = null;
        let selectedCustomerId = null;  // ê´€ë¦¬ìê°€ ì„ íƒí•œ ê³ ê° ID
        let customerData = new Map();    // ê³ ê° ì •ë³´ ì €ì¥
        let customerMessages = new Map(); // ê³ ê°ë³„ ë©”ì‹œì§€ ì €ì¥
        
        // DOM ìš”ì†Œ
        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('login-btn');
        const userIdInput = document.getElementById('user-id');
        const userPwInput = document.getElementById('user-pw');
        const loginStatus = document.getElementById('login-status');
        
        // ì¼ë°˜ ì‚¬ìš©ì ìš”ì†Œ
        const userChatContainer = document.getElementById('user-chat-container');
        const userChatHeader = document.getElementById('user-chat-header');
        const userChatMessages = document.getElementById('user-chat-messages');
        const userMessageInput = document.getElementById('user-message-input');
        const userSendBtn = document.getElementById('user-send-btn');
        const userConnectionStatus = document.getElementById('user-connection-status');
        
        // ê´€ë¦¬ì ìš”ì†Œ
        const adminChatContainer = document.getElementById('admin-chat-container');
        const customerListContent = document.getElementById('customer-list-content');
        const customerCount = document.getElementById('customer-count');
        const selectedCustomerName = document.getElementById('selected-customer-name');
        const adminChatMessages = document.getElementById('admin-chat-messages');
        const adminMessageInput = document.getElementById('admin-message-input');
        const adminSendBtn = document.getElementById('admin-send-btn');
        const adminConnectionStatus = document.getElementById('admin-connection-status');
        const noCustomerSelected = document.getElementById('no-customer-selected');
        const adminChatInput = document.getElementById('admin-chat-input');

        // ë¡œê·¸ì¸ ì²˜ë¦¬
        loginBtn.addEventListener('click', async () => {
            const userId = userIdInput.value.trim();
            const userPw = userPwInput.value.trim();
            
            if (!userId || !userPw) {
                loginStatus.textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
                return;
            }
            
            try {
                loginStatus.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
                
                // GETì—ì„œ POSTë¡œ ë³€ê²½í•˜ê³  JSON í˜•íƒœë¡œ ì „ì†¡
                const response = await fetch('/users/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: userId,
                        password: userPw
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`ë¡œê·¸ì¸ ì‹¤íŒ¨ (${response.status}): ${errorText}`);
                }
                
                const tokenData = await response.json();
                const tokenKey = Object.keys(tokenData)[0];
                const userInfo = tokenData[tokenKey];
                
                if (!userInfo) {
                    throw new Error('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                // ì‚¬ìš©ì ì •ë³´ ì„¤ì • (ê¸°ì¡´ ì½”ë“œ í•„ë“œëª…ì— ë§ì¶¤)
                userPk = userInfo.id;  // user_id â†’ id
                userEmail = userInfo.email;
                isCurrentUserAdmin = userInfo.is_admin;
                const nickname = userInfo.username;  // nickname â†’ username
                
                console.log(`ë¡œê·¸ì¸ ì„±ê³µ: ID=${userPk}, ê´€ë¦¬ì=${isCurrentUserAdmin}, ë‹‰ë„¤ì„=${nickname}`);
                
                // ë¡œê·¸ì¸ ì„±ê³µ í›„ UI í‘œì‹œ
                loginForm.style.display = 'none';
                
                if (isCurrentUserAdmin) {
                    // ê´€ë¦¬ì í™”ë©´
                    adminChatContainer.style.display = 'block';
                    adminConnectionStatus.textContent = `ê´€ë¦¬ì ëª¨ë“œ (${nickname})`;
                } else {
                    // ì¼ë°˜ ì‚¬ìš©ì í™”ë©´
                    userChatContainer.style.display = 'block';
                    userChatHeader.textContent = `ğŸ’¬ ê´€ë¦¬ìì™€ì˜ ë¬¸ì˜ ì±„íŒ… (${nickname})`;
                }
                
                // ì´ì „ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
                await loadPreviousMessages();
                
                // WebSocket ì—°ê²°
                connectWebSocket();
                
                // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
                if (isCurrentUserAdmin) {
                    adminMessageInput.focus();
                } else {
                    userMessageInput.focus();
                }
                
            } catch (error) {
                console.error('ë¡œê·¸ì¸ ì—ëŸ¬:', error);
                loginStatus.textContent = `ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`;
                loginStatus.style.color = 'red';
            }
        });

        // ê´€ë¦¬ììš©: ëª¨ë“  ëŒ€í™”ë°© ë°ì´í„° ë¡œë“œ (ê¸°ì¡´ API ê²½ë¡œ ì‚¬ìš©)
        async function loadAllConversationsForAdmin() {
            if (!isCurrentUserAdmin) {
                console.log('ê´€ë¦¬ìê°€ ì•„ë‹™ë‹ˆë‹¤');
                return;
            }
            
            try {
                console.log('ëª¨ë“  ëŒ€í™”ë°© ë¡œë”© ì‹œì‘...');
                
                const response = await fetch('/chat/all', {  // ê¸°ì¡´ chat API ì‚¬ìš©
                    method: 'GET'
                });
                
                if (!response.ok) {
                    console.warn('ëŒ€í™”ë°© ë¡œë“œ ì‹¤íŒ¨:', response.status);
                    return;
                }
                
                const data = await response.json();
                console.log('ë¡œë“œëœ ì „ì²´ ëŒ€í™” ë°ì´í„°:', data);
                
                // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”
                customerData.clear();
                customerMessages.clear();
                
                // ìƒˆë¡œìš´ ë°ì´í„°ë¡œ ì„¤ì • (ê¸°ì¡´ í•„ë“œëª…ì— ë§ì¶¤)
                Object.keys(data.conversations).forEach(userPk => {
                    const conversation = data.conversations[userPk];
                    const userId = parseInt(userPk);
                    
                    // ê³ ê° ì •ë³´ ì €ì¥
                    customerData.set(userId, {
                        id: userId,
                        name: conversation.user_info.username,  // nickname â†’ username
                        email: conversation.user_info.email,
                        lastMessage: conversation.messages.length > 0 ? 
                            conversation.messages[conversation.messages.length - 1].message : 'ë©”ì‹œì§€ ì—†ìŒ',
                        unreadCount: 0
                    });
                    
                    // ë©”ì‹œì§€ ì €ì¥
                    customerMessages.set(userId, conversation.messages);
                });
                
                console.log('ê³ ê° ë°ì´í„°:', customerData);
                console.log('ë©”ì‹œì§€ ë°ì´í„°:', customerMessages);
                
                // ê³ ê° ëª©ë¡ ì—…ë°ì´íŠ¸
                updateCustomerList();
                
                console.log(`ì´ ${data.total_conversations}ê°œì˜ ëŒ€í™”ë°©ì„ ë¡œë“œí–ˆìŠµë‹ˆë‹¤`);
                
            } catch (error) {
                console.error('ëª¨ë“  ëŒ€í™”ë°© ë¡œë“œ ì—ëŸ¬:', error);
            }
        }

        // ì´ì „ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadPreviousMessages() {
            try {
                if (isCurrentUserAdmin) {
                    // ê´€ë¦¬ìë©´ ëª¨ë“  ëŒ€í™”ë°© ë¡œë“œ
                    await loadAllConversationsForAdmin();
                } else {
                    // ì¼ë°˜ ì‚¬ìš©ì: ìì‹ ì˜ ë©”ì‹œì§€ë§Œ ë¡œë“œ
                    await loadUserMessages();
                }
                
            } catch (error) {
                console.error('ë©”ì‹œì§€ ë¡œë“œ ì—ëŸ¬:', error);
                if (!isCurrentUserAdmin) {
                    displayWelcomeMessage();
                }
            }
        }

        // ì¼ë°˜ ì‚¬ìš©ì ë©”ì‹œì§€ ë¡œë“œ (ê¸°ì¡´ API ì‚¬ìš©)
        async function loadUserMessages() {
            try {
                console.log('ì‚¬ìš©ì ë©”ì‹œì§€ ë¡œë“œ ì‹œì‘, userPk:', userPk);
                
                const response = await fetch('/chat/get_messages', {  // ê¸°ì¡´ chat API ì‚¬ìš©
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_pk: userPk,
                        message: "",  // ChatCreateDTO ìŠ¤í‚¤ë§ˆì— ë§ì¶¤
                        is_from_admin: false
                    })
                });
                
                console.log('get_messages ì‘ë‹µ ìƒíƒœ:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.warn('ì´ì „ ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', response.status, errorText);
                    displayWelcomeMessage();
                    return;
                }
                
                const messages = await response.json();
                console.log('ë¡œë“œëœ ë©”ì‹œì§€ë“¤:', messages);
                
                // ë©”ì‹œì§€ í‘œì‹œ
                userChatMessages.innerHTML = '';
                
                if (Array.isArray(messages) && messages.length > 0) {
                    messages.forEach((msg, index) => {
                        console.log(`ë©”ì‹œì§€ ${index}:`, msg);
                        displayUserMessage(msg);
                    });
                } else {
                    console.log('ë©”ì‹œì§€ê°€ ì—†ìŒ');
                    displayWelcomeMessage();
                }
                
            } catch (error) {
                console.error('ì‚¬ìš©ì ë©”ì‹œì§€ ë¡œë“œ ì—ëŸ¬:', error);
                displayWelcomeMessage();
            }
        }

        // í™˜ì˜ ë©”ì‹œì§€ í‘œì‹œ (ì¼ë°˜ ì‚¬ìš©ììš©)
        function displayWelcomeMessage() {
            const welcomeElement = document.createElement('div');
            welcomeElement.innerHTML = `
                <div style="text-align: center; color: #666; font-style: italic; margin: 20px 0;">
                    ì²˜ìŒ ë¬¸ì˜í•˜ì‹œëŠ”êµ°ìš”! ì–¸ì œë“  í¸í•˜ê²Œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”. ğŸŒŸ
                </div>
            `;
            userChatMessages.appendChild(welcomeElement);
        }

        // WebSocket ì—°ê²° (ìƒˆë¡œìš´ payload ë°©ì‹ ì‚¬ìš©)
        function connectWebSocket() {
            if (socket) {
                socket.close();
            }
            
            if (isCurrentUserAdmin) {
                adminConnectionStatus.textContent = 'ì—°ê²° ìƒíƒœ: ì—°ê²° ì¤‘...';
            } else {
                userConnectionStatus.textContent = 'ì—°ê²° ìƒíƒœ: ì—°ê²° ì¤‘...';
            }
            
            const wsUrl = `ws://${window.location.host}/websocket/ws/chats`;  // ìƒˆë¡œìš´ WebSocket ê²½ë¡œ
            console.log('WebSocket ì—°ê²° ì‹œë„:', wsUrl);
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = () => {
                console.log(`WebSocket ì—°ê²° ì„±ê³µ - ì‚¬ìš©ì ID: ${userPk}`);
                
                // ì—°ê²° ì¦‰ì‹œ ì‚¬ìš©ì ì •ë³´ ì „ì†¡
                const connectMessage = {
                    user_pk: userPk,
                    message: "__CONNECT__",  // ì—°ê²°ìš© íŠ¹ìˆ˜ ë©”ì‹œì§€
                    is_from_admin: isCurrentUserAdmin
                };
                socket.send(JSON.stringify(connectMessage));
                
                if (isCurrentUserAdmin) {
                    adminConnectionStatus.textContent = `ì—°ê²° ìƒíƒœ: ê´€ë¦¬ì ëª¨ë“œ í™œì„± âœ…`;
                } else {
                    userConnectionStatus.textContent = `ì—°ê²° ìƒíƒœ: ê´€ë¦¬ìì™€ ì—°ê²°ë¨ âœ…`;
                }
            };
            
            socket.onmessage = (event) => {
                console.log('ë©”ì‹œì§€ ìˆ˜ì‹ :', event.data);
                const message = JSON.parse(event.data);
                
                if (isCurrentUserAdmin) {
                    // ê´€ë¦¬ì: ê³ ê° ë©”ì‹œì§€ë§Œ ì²˜ë¦¬ (ìì‹ ì´ ë³´ë‚¸ ê´€ë¦¬ì ë©”ì‹œì§€ëŠ” ë¬´ì‹œ)
                    if (!message.is_from_admin) {
                        handleAdminMessage(message);
                    }
                } else {
                    // ê³ ê°: ê´€ë¦¬ì ë©”ì‹œì§€ë§Œ ì²˜ë¦¬ (ìì‹ ì´ ë³´ë‚¸ ê³ ê° ë©”ì‹œì§€ëŠ” ë¬´ì‹œ)
                    if (message.is_from_admin) {
                        displayUserMessage(message);
                        
                        // ê´€ë¦¬ì ë©”ì‹œì§€ê°€ ì˜¤ë©´ ì•Œë¦¼
                        document.title = 'ğŸ“© ìƒˆ ë‹µë³€ - ê³ ê° ë¬¸ì˜ ì±„íŒ…';
                        setTimeout(() => {
                            document.title = 'ê³ ê° ë¬¸ì˜ ì±„íŒ…';
                        }, 3000);
                    }
                }
            };
            
            socket.onclose = () => {
                console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
                if (isCurrentUserAdmin) {
                    adminConnectionStatus.textContent = 'ì—°ê²° ìƒíƒœ: ì—°ê²° ëŠê¹€ âŒ';
                } else {
                    userConnectionStatus.textContent = 'ì—°ê²° ìƒíƒœ: ì—°ê²° ëŠê¹€ âŒ';
                }
                setTimeout(connectWebSocket, 5000);
            };
            
            socket.onerror = (error) => {
                console.error('WebSocket ì—ëŸ¬:', error);
                if (isCurrentUserAdmin) {
                    adminConnectionStatus.textContent = 'ì—°ê²° ìƒíƒœ: ì˜¤ë¥˜ ë°œìƒ âš ï¸';
                } else {
                    userConnectionStatus.textContent = 'ì—°ê²° ìƒíƒœ: ì˜¤ë¥˜ ë°œìƒ âš ï¸';
                }
            };
        }

        // ê´€ë¦¬ì ë©”ì‹œì§€ ì²˜ë¦¬
        function handleAdminMessage(message) {
            const customerId = message.user_pk;
            
            // ê³ ê° ì •ë³´ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
            if (!customerData.has(customerId)) {
                customerData.set(customerId, {
                    id: customerId,
                    name: `ê³ ê° ${customerId}`,
                    email: `customer${customerId}@example.com`,
                    lastMessage: '',
                    unreadCount: 0
                });
            }
            
            // ë©”ì‹œì§€ ì €ì¥
            if (!customerMessages.has(customerId)) {
                customerMessages.set(customerId, []);
            }
            customerMessages.get(customerId).push(message);
            
            // ê³ ê° ì •ë³´ ì—…ë°ì´íŠ¸
            const customer = customerData.get(customerId);
            customer.lastMessage = message.message;
            
            // í˜„ì¬ ì„ íƒëœ ê³ ê°ì´ ì•„ë‹ˆë©´ ë¯¸ì½ìŒ ì¹´ìš´íŠ¸ ì¦ê°€
            if (selectedCustomerId !== customerId) {
                customer.unreadCount++;
            }
            
            // ê³ ê° ëª©ë¡ ì—…ë°ì´íŠ¸
            updateCustomerList();
            
            // í˜„ì¬ ì„ íƒëœ ê³ ê°ì˜ ë©”ì‹œì§€ë©´ ì±„íŒ…ì°½ì— í‘œì‹œ
            if (selectedCustomerId === customerId) {
                displayAdminMessage(message);
            }
        }

        // ê³ ê° ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateCustomerList() {
            customerCount.textContent = customerData.size;
            
            if (customerData.size === 0) {
                customerListContent.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666;">
                        ì—°ê²°ëœ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤
                    </div>
                `;
                return;
            }
            
            let html = '';
            customerData.forEach((customer, customerId) => {
                const unreadBadge = customer.unreadCount > 0 ? 
                    `<div class="unread-badge">${customer.unreadCount}</div>` : '';
                
                html += `
                    <div class="customer-item ${selectedCustomerId === customerId ? 'active' : ''}" 
                         onclick="selectCustomer(${customerId})">
                        <div class="customer-name">${customer.name}</div>
                        <div class="last-message">${customer.lastMessage || 'ë©”ì‹œì§€ ì—†ìŒ'}</div>
                        ${unreadBadge}
                    </div>
                `;
            });
            
            customerListContent.innerHTML = html;
        }

        // ê³ ê° ì„ íƒ
        function selectCustomer(customerId) {
            selectedCustomerId = customerId;
            const customer = customerData.get(customerId);
            
            // ë¯¸ì½ìŒ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
            customer.unreadCount = 0;
            
            // UI ì—…ë°ì´íŠ¸
            selectedCustomerName.textContent = `${customer.name}ë‹˜ê³¼ì˜ ì±„íŒ…`;
            noCustomerSelected.style.display = 'none';
            adminChatInput.style.display = 'flex';
            
            // ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ
            displayConversationMessages(customerId);
            
            // ê³ ê° ëª©ë¡ ì—…ë°ì´íŠ¸
            updateCustomerList();
            
            // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
            adminMessageInput.focus();
        }

        // ëŒ€í™” ë©”ì‹œì§€ í‘œì‹œ
        function displayConversationMessages(customerId) {
            adminChatMessages.innerHTML = '';
            const messages = customerMessages.get(customerId) || [];
            
            if (messages.length === 0) {
                adminChatMessages.innerHTML = `
                    <div style="text-align: center; color: #666; margin-top: 50px;">
                        ì•„ì§ ëŒ€í™”ê°€ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
                    </div>
                `;
                return;
            }
            
            messages.forEach(msg => displayAdminMessage(msg));
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            adminChatMessages.scrollTop = adminChatMessages.scrollHeight;
        }

        // ì¼ë°˜ ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
        function displayUserMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');

            const time = new Date(message.created_at || Date.now()).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            if (message.is_from_admin) {
                messageElement.classList.add('admin-message');
                messageElement.innerHTML = `
                    <strong>ğŸ› ï¸ ê´€ë¦¬ì</strong><br>
                    ${message.message}
                    <div class="message-time">${time}</div>
                `;
            } else {
                messageElement.classList.add('user-message');
                messageElement.innerHTML = `
                    <strong>ë‚˜</strong><br>
                    ${message.message}
                    <div class="message-time">${time}</div>
                `;
            }

            userChatMessages.appendChild(messageElement);
            userChatMessages.scrollTop = userChatMessages.scrollHeight;
        }

        // ê´€ë¦¬ì ë©”ì‹œì§€ í‘œì‹œ
        function displayAdminMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');

            const time = new Date(message.created_at || Date.now()).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            if (message.is_from_admin) {
                messageElement.classList.add('admin-message');
                if (message.user_pk === userPk) {
                    messageElement.innerHTML = `
                        <strong>ë‚˜ (ê´€ë¦¬ì)</strong><br>
                        ${message.message}
                        <div class="message-time">${time}</div>
                    `;
                } else {
                    messageElement.innerHTML = `
                        <strong>ğŸ› ï¸ ê´€ë¦¬ì</strong><br>
                        ${message.message}
                        <div class="message-time">${time}</div>
                    `;
                }
            } else {
                messageElement.classList.add('user-message');
                messageElement.innerHTML = `
                    <strong>ğŸ‘¤ ê³ ê°</strong><br>
                    ${message.message}
                    <div class="message-time">${time}</div>
                `;
            }

            adminChatMessages.appendChild(messageElement);
            adminChatMessages.scrollTop = adminChatMessages.scrollHeight;
        }

        // ì¼ë°˜ ì‚¬ìš©ì ë©”ì‹œì§€ ì „ì†¡
        function sendUserMessage() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                alert('ê´€ë¦¬ìì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const message = userMessageInput.value.trim();
            if (!message) return;

            const messageData = {
                user_pk: userPk,
                message: message,
                is_from_admin: false
            };

            // ì¦‰ì‹œ í™”ë©´ì— í‘œì‹œ (WebSocket ì‘ë‹µ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
            const tempMessage = {
                user_pk: userPk,
                message: message,
                is_from_admin: false,
                created_at: new Date().toISOString()
            };
            displayUserMessage(tempMessage);

            socket.send(JSON.stringify(messageData));
            userMessageInput.value = '';
        }

        // ê´€ë¦¬ì ë©”ì‹œì§€ ì „ì†¡
        function sendAdminMessage() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                alert('ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!selectedCustomerId) {
                alert('ë¨¼ì € ê³ ê°ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const message = adminMessageInput.value.trim();
            if (!message) return;

            const messageData = {
                user_pk: selectedCustomerId,  // ì„ íƒëœ ê³ ê°ì—ê²Œ ì „ì†¡
                message: message,
                is_from_admin: true,
                admin_id: userPk  // ê´€ë¦¬ì ID ì¶”ê°€
            };

            // ì¦‰ì‹œ í™”ë©´ì— í‘œì‹œ (WebSocket ì‘ë‹µ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
            const tempMessage = {
                user_pk: userPk,
                message: message,
                is_from_admin: true,
                created_at: new Date().toISOString()
            };
            displayAdminMessage(tempMessage);

            // ê´€ë¦¬ì ë©”ì‹œì§€ë¥¼ ê³ ê° ë©”ì‹œì§€ ëª©ë¡ì—ë„ ì¶”ê°€
            if (!customerMessages.has(selectedCustomerId)) {
                customerMessages.set(selectedCustomerId, []);
            }
            customerMessages.get(selectedCustomerId).push({
                ...tempMessage,
                user_pk: selectedCustomerId  // ê³ ê° IDë¡œ ì €ì¥
            });

            socket.send(JSON.stringify(messageData));
            adminMessageInput.value = '';
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        userSendBtn.addEventListener('click', sendUserMessage);
        userMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendUserMessage();
        });

        adminSendBtn.addEventListener('click', sendAdminMessage);
        adminMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendAdminMessage();
        });

        userPwInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginBtn.click();
        });

        window.addEventListener('load', () => {
            userIdInput.focus();
        });
    </script>
</body>
</html>