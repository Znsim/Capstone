<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>고객 문의 채팅</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .login-container div {
            margin-bottom: 15px;
        }
        .login-container input {
            padding: 10px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .login-container button {
            padding: 12px 20px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }
        
        /* 일반 사용자 채팅 화면 */
        .user-chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        
        /* 관리자 채팅 화면 */
        .admin-chat-container {
            display: none;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 80vh;
        }
        .admin-layout {
            display: flex;
            height: 100%;
        }
        .customer-list {
            width: 300px;
            border-right: 1px solid #ddd;
            background-color: #f8f9fa;
        }
        .customer-list-header {
            padding: 15px;
            background-color: #343a40;
            color: white;
            font-weight: bold;
        }
        .customer-item {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            position: relative;
        }
        .customer-item:hover {
            background-color: #e9ecef;
        }
        .customer-item.active {
            background-color: #007bff;
            color: white;
        }
        .customer-item .customer-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        .customer-item .last-message {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .customer-item.active .last-message {
            color: #fff;
        }
        .unread-badge {
            position: absolute;
            top: 8px;
            right: 10px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 15px;
            background-color: #2196f3;
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #f9f9f9;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 70%;
            word-break: break-word;
        }
        .user-message {
            background-color: #e3f2fd;
            margin-right: auto;
        }
        .admin-message {
            background-color: #fff3e0;
            margin-left: auto;
            border-left: 4px solid #ff9800;
        }
        .message-time {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }
        .chat-input {
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        .chat-input button {
            padding: 10px 20px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }
        .chat-input button:hover {
            background-color: #388e3c;
        }
        .status {
            text-align: center;
            font-size: 12px;
            color: #666;
            padding: 10px;
        }
        .welcome-msg {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
        }
        .no-customer-selected {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center;">🛠️ 고객 문의 채팅 시스템</h1>

        <!-- 로그인 폼 -->
        <div class="login-container" id="login-form">
            <h3 style="text-align: center;">로그인</h3>
            <div>
                <label for="user-id">이메일:</label>
                <input type="text" id="user-id" placeholder="이메일을 입력하세요">
            </div>
            <div>
                <label for="user-pw">비밀번호:</label>
                <input type="password" id="user-pw" placeholder="비밀번호를 입력하세요">
            </div>
            <button id="login-btn">로그인</button>
            <div style="text-align: center; margin-top: 10px;">
                <span id="login-status"></span>
            </div>
        </div>

        <!-- 일반 사용자 채팅 화면 -->
        <div class="user-chat-container" id="user-chat-container">
            <div class="chat-header" id="user-chat-header">💬 관리자와의 문의 채팅</div>
            
            <div class="welcome-msg">
                안녕하세요! 궁금한 점이나 문의사항을 자유롭게 남겨주세요. <br>
                관리자가 최대한 빠르게 답변드리겠습니다. 😊
            </div>
            
            <div class="chat-messages" id="user-chat-messages"></div>
            
            <div class="chat-input">
                <input type="text" id="user-message-input" placeholder="문의 내용을 입력하세요...">
                <button id="user-send-btn">전송</button>
            </div>
            
            <div class="status" id="user-connection-status">연결 상태: 대기중</div>
        </div>

        <!-- 관리자 채팅 화면 -->
        <div class="admin-chat-container" id="admin-chat-container">
            <div class="admin-layout">
                <!-- 고객 목록 -->
                <div class="customer-list">
                    <div class="customer-list-header">
                        💼 고객 목록 (<span id="customer-count">0</span>)
                    </div>
                    <div id="customer-list-content">
                        <div style="padding: 20px; text-align: center; color: #666;">
                            연결된 고객이 없습니다
                        </div>
                    </div>
                </div>
                
                <!-- 채팅 영역 -->
                <div class="chat-area">
                    <div class="chat-header" id="admin-chat-header">
                        <span id="selected-customer-name">고객을 선택하세요</span>
                        <span id="admin-connection-status">연결 상태: 대기중</span>
                    </div>
                    
                    <div class="chat-messages" id="admin-chat-messages">
                        <div class="no-customer-selected" id="no-customer-selected">
                            👈 왼쪽에서 고객을 선택하면 채팅을 시작할 수 있습니다
                        </div>
                    </div>
                    
                    <div class="chat-input" id="admin-chat-input" style="display: none;">
                        <input type="text" id="admin-message-input" placeholder="답변을 입력하세요...">
                        <button id="admin-send-btn">전송</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 상태 변수
        let userPk = null;
        let userEmail = null;
        let isCurrentUserAdmin = false;
        let socket = null;
        let selectedCustomerId = null;  // 관리자가 선택한 고객 ID
        let customerData = new Map();    // 고객 정보 저장
        let customerMessages = new Map(); // 고객별 메시지 저장
        
        // DOM 요소
        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('login-btn');
        const userIdInput = document.getElementById('user-id');
        const userPwInput = document.getElementById('user-pw');
        const loginStatus = document.getElementById('login-status');
        
        // 일반 사용자 요소
        const userChatContainer = document.getElementById('user-chat-container');
        const userChatHeader = document.getElementById('user-chat-header');
        const userChatMessages = document.getElementById('user-chat-messages');
        const userMessageInput = document.getElementById('user-message-input');
        const userSendBtn = document.getElementById('user-send-btn');
        const userConnectionStatus = document.getElementById('user-connection-status');
        
        // 관리자 요소
        const adminChatContainer = document.getElementById('admin-chat-container');
        const customerListContent = document.getElementById('customer-list-content');
        const customerCount = document.getElementById('customer-count');
        const selectedCustomerName = document.getElementById('selected-customer-name');
        const adminChatMessages = document.getElementById('admin-chat-messages');
        const adminMessageInput = document.getElementById('admin-message-input');
        const adminSendBtn = document.getElementById('admin-send-btn');
        const adminConnectionStatus = document.getElementById('admin-connection-status');
        const noCustomerSelected = document.getElementById('no-customer-selected');
        const adminChatInput = document.getElementById('admin-chat-input');

        // 로그인 처리
        loginBtn.addEventListener('click', async () => {
            const userId = userIdInput.value.trim();
            const userPw = userPwInput.value.trim();
            
            if (!userId || !userPw) {
                loginStatus.textContent = '이메일과 비밀번호를 입력하세요';
                return;
            }
            
            try {
                loginStatus.textContent = '로그인 중...';
                
                // GET에서 POST로 변경하고 JSON 형태로 전송
                const response = await fetch('/users/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: userId,
                        password: userPw
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`로그인 실패 (${response.status}): ${errorText}`);
                }
                
                const tokenData = await response.json();
                const tokenKey = Object.keys(tokenData)[0];
                const userInfo = tokenData[tokenKey];
                
                if (!userInfo) {
                    throw new Error('사용자 정보를 찾을 수 없습니다');
                }
                
                // 사용자 정보 설정 (기존 코드 필드명에 맞춤)
                userPk = userInfo.id;  // user_id → id
                userEmail = userInfo.email;
                isCurrentUserAdmin = userInfo.is_admin;
                const nickname = userInfo.username;  // nickname → username
                
                console.log(`로그인 성공: ID=${userPk}, 관리자=${isCurrentUserAdmin}, 닉네임=${nickname}`);
                
                // 로그인 성공 후 UI 표시
                loginForm.style.display = 'none';
                
                if (isCurrentUserAdmin) {
                    // 관리자 화면
                    adminChatContainer.style.display = 'block';
                    adminConnectionStatus.textContent = `관리자 모드 (${nickname})`;
                } else {
                    // 일반 사용자 화면
                    userChatContainer.style.display = 'block';
                    userChatHeader.textContent = `💬 관리자와의 문의 채팅 (${nickname})`;
                }
                
                // 이전 메시지 불러오기
                await loadPreviousMessages();
                
                // WebSocket 연결
                connectWebSocket();
                
                // 입력창에 포커스
                if (isCurrentUserAdmin) {
                    adminMessageInput.focus();
                } else {
                    userMessageInput.focus();
                }
                
            } catch (error) {
                console.error('로그인 에러:', error);
                loginStatus.textContent = `로그인 실패: ${error.message}`;
                loginStatus.style.color = 'red';
            }
        });

        // 관리자용: 모든 대화방 데이터 로드 (기존 API 경로 사용)
        async function loadAllConversationsForAdmin() {
            if (!isCurrentUserAdmin) {
                console.log('관리자가 아닙니다');
                return;
            }
            
            try {
                console.log('모든 대화방 로딩 시작...');
                
                const response = await fetch('/chat/all', {  // 기존 chat API 사용
                    method: 'GET'
                });
                
                if (!response.ok) {
                    console.warn('대화방 로드 실패:', response.status);
                    return;
                }
                
                const data = await response.json();
                console.log('로드된 전체 대화 데이터:', data);
                
                // 기존 데이터 초기화
                customerData.clear();
                customerMessages.clear();
                
                // 새로운 데이터로 설정 (기존 필드명에 맞춤)
                Object.keys(data.conversations).forEach(userPk => {
                    const conversation = data.conversations[userPk];
                    const userId = parseInt(userPk);
                    
                    // 고객 정보 저장
                    customerData.set(userId, {
                        id: userId,
                        name: conversation.user_info.username,  // nickname → username
                        email: conversation.user_info.email,
                        lastMessage: conversation.messages.length > 0 ? 
                            conversation.messages[conversation.messages.length - 1].message : '메시지 없음',
                        unreadCount: 0
                    });
                    
                    // 메시지 저장
                    customerMessages.set(userId, conversation.messages);
                });
                
                console.log('고객 데이터:', customerData);
                console.log('메시지 데이터:', customerMessages);
                
                // 고객 목록 업데이트
                updateCustomerList();
                
                console.log(`총 ${data.total_conversations}개의 대화방을 로드했습니다`);
                
            } catch (error) {
                console.error('모든 대화방 로드 에러:', error);
            }
        }

        // 이전 메시지 불러오기
        async function loadPreviousMessages() {
            try {
                if (isCurrentUserAdmin) {
                    // 관리자면 모든 대화방 로드
                    await loadAllConversationsForAdmin();
                } else {
                    // 일반 사용자: 자신의 메시지만 로드
                    await loadUserMessages();
                }
                
            } catch (error) {
                console.error('메시지 로드 에러:', error);
                if (!isCurrentUserAdmin) {
                    displayWelcomeMessage();
                }
            }
        }

        // 일반 사용자 메시지 로드 (기존 API 사용)
        async function loadUserMessages() {
            try {
                console.log('사용자 메시지 로드 시작, userPk:', userPk);
                
                const response = await fetch('/chat/get_messages', {  // 기존 chat API 사용
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_pk: userPk,
                        message: "",  // ChatCreateDTO 스키마에 맞춤
                        is_from_admin: false
                    })
                });
                
                console.log('get_messages 응답 상태:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.warn('이전 메시지 로드 실패:', response.status, errorText);
                    displayWelcomeMessage();
                    return;
                }
                
                const messages = await response.json();
                console.log('로드된 메시지들:', messages);
                
                // 메시지 표시
                userChatMessages.innerHTML = '';
                
                if (Array.isArray(messages) && messages.length > 0) {
                    messages.forEach((msg, index) => {
                        console.log(`메시지 ${index}:`, msg);
                        displayUserMessage(msg);
                    });
                } else {
                    console.log('메시지가 없음');
                    displayWelcomeMessage();
                }
                
            } catch (error) {
                console.error('사용자 메시지 로드 에러:', error);
                displayWelcomeMessage();
            }
        }

        // 환영 메시지 표시 (일반 사용자용)
        function displayWelcomeMessage() {
            const welcomeElement = document.createElement('div');
            welcomeElement.innerHTML = `
                <div style="text-align: center; color: #666; font-style: italic; margin: 20px 0;">
                    처음 문의하시는군요! 언제든 편하게 질문해주세요. 🌟
                </div>
            `;
            userChatMessages.appendChild(welcomeElement);
        }

        // WebSocket 연결 (새로운 payload 방식 사용)
        function connectWebSocket() {
            if (socket) {
                socket.close();
            }
            
            if (isCurrentUserAdmin) {
                adminConnectionStatus.textContent = '연결 상태: 연결 중...';
            } else {
                userConnectionStatus.textContent = '연결 상태: 연결 중...';
            }
            
            const wsUrl = `ws://${window.location.host}/websocket/ws/chats`;  // 새로운 WebSocket 경로
            console.log('WebSocket 연결 시도:', wsUrl);
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = () => {
                console.log(`WebSocket 연결 성공 - 사용자 ID: ${userPk}`);
                
                // 연결 즉시 사용자 정보 전송
                const connectMessage = {
                    user_pk: userPk,
                    message: "__CONNECT__",  // 연결용 특수 메시지
                    is_from_admin: isCurrentUserAdmin
                };
                socket.send(JSON.stringify(connectMessage));
                
                if (isCurrentUserAdmin) {
                    adminConnectionStatus.textContent = `연결 상태: 관리자 모드 활성 ✅`;
                } else {
                    userConnectionStatus.textContent = `연결 상태: 관리자와 연결됨 ✅`;
                }
            };
            
            socket.onmessage = (event) => {
                console.log('메시지 수신:', event.data);
                const message = JSON.parse(event.data);
                
                if (isCurrentUserAdmin) {
                    // 관리자: 고객 메시지만 처리 (자신이 보낸 관리자 메시지는 무시)
                    if (!message.is_from_admin) {
                        handleAdminMessage(message);
                    }
                } else {
                    // 고객: 관리자 메시지만 처리 (자신이 보낸 고객 메시지는 무시)
                    if (message.is_from_admin) {
                        displayUserMessage(message);
                        
                        // 관리자 메시지가 오면 알림
                        document.title = '📩 새 답변 - 고객 문의 채팅';
                        setTimeout(() => {
                            document.title = '고객 문의 채팅';
                        }, 3000);
                    }
                }
            };
            
            socket.onclose = () => {
                console.log('WebSocket 연결 종료');
                if (isCurrentUserAdmin) {
                    adminConnectionStatus.textContent = '연결 상태: 연결 끊김 ❌';
                } else {
                    userConnectionStatus.textContent = '연결 상태: 연결 끊김 ❌';
                }
                setTimeout(connectWebSocket, 5000);
            };
            
            socket.onerror = (error) => {
                console.error('WebSocket 에러:', error);
                if (isCurrentUserAdmin) {
                    adminConnectionStatus.textContent = '연결 상태: 오류 발생 ⚠️';
                } else {
                    userConnectionStatus.textContent = '연결 상태: 오류 발생 ⚠️';
                }
            };
        }

        // 관리자 메시지 처리
        function handleAdminMessage(message) {
            const customerId = message.user_pk;
            
            // 고객 정보가 없으면 추가
            if (!customerData.has(customerId)) {
                customerData.set(customerId, {
                    id: customerId,
                    name: `고객 ${customerId}`,
                    email: `customer${customerId}@example.com`,
                    lastMessage: '',
                    unreadCount: 0
                });
            }
            
            // 메시지 저장
            if (!customerMessages.has(customerId)) {
                customerMessages.set(customerId, []);
            }
            customerMessages.get(customerId).push(message);
            
            // 고객 정보 업데이트
            const customer = customerData.get(customerId);
            customer.lastMessage = message.message;
            
            // 현재 선택된 고객이 아니면 미읽음 카운트 증가
            if (selectedCustomerId !== customerId) {
                customer.unreadCount++;
            }
            
            // 고객 목록 업데이트
            updateCustomerList();
            
            // 현재 선택된 고객의 메시지면 채팅창에 표시
            if (selectedCustomerId === customerId) {
                displayAdminMessage(message);
            }
        }

        // 고객 목록 업데이트
        function updateCustomerList() {
            customerCount.textContent = customerData.size;
            
            if (customerData.size === 0) {
                customerListContent.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666;">
                        연결된 고객이 없습니다
                    </div>
                `;
                return;
            }
            
            let html = '';
            customerData.forEach((customer, customerId) => {
                const unreadBadge = customer.unreadCount > 0 ? 
                    `<div class="unread-badge">${customer.unreadCount}</div>` : '';
                
                html += `
                    <div class="customer-item ${selectedCustomerId === customerId ? 'active' : ''}" 
                         onclick="selectCustomer(${customerId})">
                        <div class="customer-name">${customer.name}</div>
                        <div class="last-message">${customer.lastMessage || '메시지 없음'}</div>
                        ${unreadBadge}
                    </div>
                `;
            });
            
            customerListContent.innerHTML = html;
        }

        // 고객 선택
        function selectCustomer(customerId) {
            selectedCustomerId = customerId;
            const customer = customerData.get(customerId);
            
            // 미읽음 카운트 초기화
            customer.unreadCount = 0;
            
            // UI 업데이트
            selectedCustomerName.textContent = `${customer.name}님과의 채팅`;
            noCustomerSelected.style.display = 'none';
            adminChatInput.style.display = 'flex';
            
            // 채팅 메시지 표시
            displayConversationMessages(customerId);
            
            // 고객 목록 업데이트
            updateCustomerList();
            
            // 입력창에 포커스
            adminMessageInput.focus();
        }

        // 대화 메시지 표시
        function displayConversationMessages(customerId) {
            adminChatMessages.innerHTML = '';
            const messages = customerMessages.get(customerId) || [];
            
            if (messages.length === 0) {
                adminChatMessages.innerHTML = `
                    <div style="text-align: center; color: #666; margin-top: 50px;">
                        아직 대화가 시작되지 않았습니다.
                    </div>
                `;
                return;
            }
            
            messages.forEach(msg => displayAdminMessage(msg));
            
            // 스크롤을 맨 아래로
            adminChatMessages.scrollTop = adminChatMessages.scrollHeight;
        }

        // 일반 사용자 메시지 표시
        function displayUserMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');

            const time = new Date(message.created_at || Date.now()).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            if (message.is_from_admin) {
                messageElement.classList.add('admin-message');
                messageElement.innerHTML = `
                    <strong>🛠️ 관리자</strong><br>
                    ${message.message}
                    <div class="message-time">${time}</div>
                `;
            } else {
                messageElement.classList.add('user-message');
                messageElement.innerHTML = `
                    <strong>나</strong><br>
                    ${message.message}
                    <div class="message-time">${time}</div>
                `;
            }

            userChatMessages.appendChild(messageElement);
            userChatMessages.scrollTop = userChatMessages.scrollHeight;
        }

        // 관리자 메시지 표시
        function displayAdminMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');

            const time = new Date(message.created_at || Date.now()).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            if (message.is_from_admin) {
                messageElement.classList.add('admin-message');
                if (message.user_pk === userPk) {
                    messageElement.innerHTML = `
                        <strong>나 (관리자)</strong><br>
                        ${message.message}
                        <div class="message-time">${time}</div>
                    `;
                } else {
                    messageElement.innerHTML = `
                        <strong>🛠️ 관리자</strong><br>
                        ${message.message}
                        <div class="message-time">${time}</div>
                    `;
                }
            } else {
                messageElement.classList.add('user-message');
                messageElement.innerHTML = `
                    <strong>👤 고객</strong><br>
                    ${message.message}
                    <div class="message-time">${time}</div>
                `;
            }

            adminChatMessages.appendChild(messageElement);
            adminChatMessages.scrollTop = adminChatMessages.scrollHeight;
        }

        // 일반 사용자 메시지 전송
        function sendUserMessage() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                alert('관리자와의 연결이 끊어졌습니다. 잠시 후 다시 시도해주세요.');
                return;
            }
            
            const message = userMessageInput.value.trim();
            if (!message) return;

            const messageData = {
                user_pk: userPk,
                message: message,
                is_from_admin: false
            };

            // 즉시 화면에 표시 (WebSocket 응답 기다리지 않음)
            const tempMessage = {
                user_pk: userPk,
                message: message,
                is_from_admin: false,
                created_at: new Date().toISOString()
            };
            displayUserMessage(tempMessage);

            socket.send(JSON.stringify(messageData));
            userMessageInput.value = '';
        }

        // 관리자 메시지 전송
        function sendAdminMessage() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                alert('연결이 끊어졌습니다. 잠시 후 다시 시도해주세요.');
                return;
            }
            
            if (!selectedCustomerId) {
                alert('먼저 고객을 선택해주세요.');
                return;
            }
            
            const message = adminMessageInput.value.trim();
            if (!message) return;

            const messageData = {
                user_pk: selectedCustomerId,  // 선택된 고객에게 전송
                message: message,
                is_from_admin: true,
                admin_id: userPk  // 관리자 ID 추가
            };

            // 즉시 화면에 표시 (WebSocket 응답 기다리지 않음)
            const tempMessage = {
                user_pk: userPk,
                message: message,
                is_from_admin: true,
                created_at: new Date().toISOString()
            };
            displayAdminMessage(tempMessage);

            // 관리자 메시지를 고객 메시지 목록에도 추가
            if (!customerMessages.has(selectedCustomerId)) {
                customerMessages.set(selectedCustomerId, []);
            }
            customerMessages.get(selectedCustomerId).push({
                ...tempMessage,
                user_pk: selectedCustomerId  // 고객 ID로 저장
            });

            socket.send(JSON.stringify(messageData));
            adminMessageInput.value = '';
        }

        // 이벤트 리스너
        userSendBtn.addEventListener('click', sendUserMessage);
        userMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendUserMessage();
        });

        adminSendBtn.addEventListener('click', sendAdminMessage);
        adminMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendAdminMessage();
        });

        userPwInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginBtn.click();
        });

        window.addEventListener('load', () => {
            userIdInput.focus();
        });
    </script>
</body>
</html>